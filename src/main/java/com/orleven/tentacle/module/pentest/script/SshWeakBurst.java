package com.orleven.tentacle.module.pentest.script;

import org.springframework.context.annotation.Scope;
import org.springframework.stereotype.Component;

import com.orleven.tentacle.core.IOC;
import com.orleven.tentacle.define.Message;
import com.orleven.tentacle.define.Permeate;
import com.orleven.tentacle.module.bean.ProveBean;
import com.orleven.tentacle.module.pentest.SshAbstractScript;
import com.orleven.tentacle.util.SshUtil;

/**
 * SSH 端口爆破
 * @author orleven
 * @date 2017年3月22日
 */
@Component
public class SshWeakBurst extends SshAbstractScript{
	
	public SshWeakBurst(){
		super();
	}
	
	@Override
	public void prove() {
//		ProveBean proveBean= IOC.ctx.getBean(ProveBean.class);
		String result ;
		String username = getUsername();
		String password = getPassword() ;
		while(true){
			result = SshUtil.login(getSshServiceBean().getBasicInfoBean().getHost(), username, password, getSshServiceBean().getServiceBean().getPort());
			if (result.indexOf(Message.AuthSuccess)>=0){
//				proveBean.setReceiveMessage(result);
//				proveBean.setSendMessage("[+] Username: "+ username + "\r\n[+] Password: " + password);
				getVulnerBean().getProveBeans().addReceiveMessage(result);
				getVulnerBean().getProveBeans().addSendMessage("[+] Username: "+ username + "\r\n[+] Password: " + password);
				getVulnerBean().setIsVulner(Permeate.isVulner);
				break;
			}
			else if (result.indexOf("Auth fail")>=0){
				break;
			}
			else {
				// Connection reset
				// connection is closed by foreign host
				// Unrecognized Windows Sockets error
//				System.out.println(result);
			}
		}
	}
	
	@Override
	public void execCommand(String command) {
//		ProveBean proveBean= IOC.ctx.getBean(ProveBean.class);
		String result = SshUtil.loginExec(getSshServiceBean().getBasicInfoBean().getHost(), getUsername(), getPassword(), getSshServiceBean().getServiceBean().getPort(),command);
//		proveBean.setReceiveMessage(result);
//		proveBean.setSendMessage("command : " + command);
		getVulnerBean().getProveBeans().addReceiveMessage(result);
		getVulnerBean().getProveBeans().addSendMessage("[+] Command : " + command);
//		getVulnerBean().getProveBeans().add(proveBean);
	}
	

	@Override
	public void uploadFile(String inFile,String outFile) {
		
	}
}
